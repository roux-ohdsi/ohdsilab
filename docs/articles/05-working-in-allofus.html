<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Intro to the AllofUs Workbench • ohdsilab</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Intro to the AllofUs Workbench">
<meta property="og:description" content="ohdsilab">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">ohdsilab</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.1.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/01-intro-to-ohdsilab.html">Introduction to ohdsilab</a>
    </li>
    <li>
      <a href="../articles/02-Generating-a-cohort.html">Generating a cohort</a>
    </li>
    <li>
      <a href="../articles/03-feature-extraction-covariates.html">Generating Covariates and Table 1</a>
    </li>
    <li>
      <a href="../articles/04-working-with-omop-cdm.html">Working with Data from the ohdsilab database</a>
    </li>
    <li>
      <a href="../articles/05-working-in-allofus.html">Intro to the AllofUs Workbench</a>
    </li>
    <li>
      <a href="../articles/getting-started-with-box.html">Getting Started with the OHDSI-Lab Box</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Intro to the AllofUs Workbench</h1>
            
      
      
      <div class="hidden name"><code>05-working-in-allofus.Rmd</code></div>

    </div>

    
    
<p>This brief tutorial will describe a few useful functions for working
in the AllofUs researcher workbench.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://roux-ohdsi.github.io/ohdsilab/" class="external-link">ohdsilab</a></span><span class="op">)</span></span></code></pre></div>
<div class="section level3">
<h3 id="main-points">Main Points<a class="anchor" aria-label="anchor" href="#main-points"></a>
</h3>
<p>Working with data in AllofUs is similar to working with
ohdsilab/pharmetrics with a few important differences:</p>
<ul>
<li><p>AllofUs includes data from most of the typical OMOP CDM tables,
as well as a few additional AllofUs specific tables. The data dictionary
for the registered tier can be found <a href="https://docs.google.com/spreadsheets/d/1HNxLGGKCJFWi5dBXiFgu3nZlV6klMLiHVjqANCu03UY/edit#gid=183931508" class="external-link">here</a>
and the controlled tier <a href="https://docs.google.com/spreadsheets/d/1XLVq84LLd0VZMioF2sPwyiaPw3EFp5c8o1CTWGPH-Yc/edit#gid=183931508" class="external-link">here</a>.
For the most part, the additional tables hold data collected by AllofUs
that is not typical of EHR or claims data (e.g., fitbit data).</p></li>
<li><p>We can’t write temporary tables on the database in AllofUs.
Unfortunately, this means that most of the OHDSI R packages are largely
rendered useless. It also means that we can’t use SQL/JSON code
generated by ATLAS to pull a cohort (because this code also uses
temporary tables). We’ve asked about solutions to this and haven’t
gotten very far. ¯\_(ツ)_/¯</p></li>
<li>
<p>It’s important to understand where data is stored for AllofUs.
Each user has a persistent disk that is specific to that user. For a
given workspace, there is a shared “data bucket” that holds data that
anyone with access to the workspace can access. Unless you’re sure that
no one else will need to see the data or the scripts that use the data,
we currently recommend only using the bucket for storage. However,
unlike the persistent disk, we can’t just run
<code>read.csv("data.csv")</code> from the bucket. We have to move data
from the bucket into the current environment first (more on how to do
this later).</p>
<p><img src="images/image-169521206.png" width="600"></p>
</li>
<li><p>You are (currently) required to work in jupyter notebooks instead
of RStudio (though RStudio is coming)</p></li>
<li>
<p>AllofUS has written some code snippets which help complete
frequent tasks, like moving data between the environment, persistent
disk, and bucket, or accessing certain tables. You can find these
snippets in the “Snippets” dropdown in the Jupyter Notebook.</p>
<p><img src="images/image-1643830709.png" width="600"></p>
</li>
</ul>
</div>
<div class="section level3">
<h3 id="useful-code-from-the-ohdsilab-r-package">Useful code from the ohdsilab R package<a class="anchor" aria-label="anchor" href="#useful-code-from-the-ohdsilab-r-package"></a>
</h3>
<p>The <code><a href="../reference/aou_connect.html">aou_connect()</a></code> function connects to the AllofUs
database and saves that connection as an object in the R Session called
<code>con</code>. It also establishes an object for the workspace
bucket, called <code>bucket</code>. You should run this after loading
your packages. It’ll tell you if you’ve connected successfully.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/aou_connect.html">aou_connect</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>The <code>aou_ls()</code> function lists files in the bucket
following a pattern. It defaults to <code>*csv</code> to list all .csv
files, but can be changed to anything.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">aou_ls</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>The <code>aou_save_to_bucket()</code> function saves a file from your
current disk to the bucket. You can use it after writing the object to a
file. It can work for more than .csv files too.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/write.table.html" class="external-link">write.csv</a></span><span class="op">(</span><span class="va">myData</span>, <span class="st">"data.csv"</span><span class="op">)</span></span>
<span><span class="fu">aou_save_to_bucket</span><span class="op">(</span><span class="st">"data.csv"</span><span class="op">)</span></span></code></pre></div>
<p>The <code>aou_retrieve_from_bucket()</code> function will retrieve a
file from the bucket, so that you can read it into your notebook.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">aou_retrieve_from_bucket</span><span class="op">(</span><span class="st">"data.csv"</span><span class="op">)</span></span>
<span><span class="va">data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html" class="external-link">read.csv</a></span><span class="op">(</span><span class="st">"data.csv"</span><span class="op">)</span></span></code></pre></div>
<p>After this, working with AllofUs is pretty similar to
ohdsilab/pharmetrics.</p>
</div>
<div class="section level3">
<h3 id="example">Example<a class="anchor" aria-label="anchor" href="#example"></a>
</h3>
<p>Start by loading packages and connecting to the database</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org" class="external-link">tidyverse</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://roux-ohdsi.github.io/ohdsilab/" class="external-link">ohdsilab</a></span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/aou_connect.html">aou_connect</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>The following code would start a query for the first survey date for
the AllofUs survey “The Basics” (sometimes, but rarely, participants
completed this survey over multiple dates).</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">survey_dates</span> <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/tbl.html" class="external-link">tbl</a></span><span class="op">(</span><span class="va">con</span>, <span class="st">"ds_survey"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">survey</span> <span class="op">==</span> <span class="st">"The Basics"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">person_id</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">survey_datetime</span> <span class="op">==</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">survey_datetime</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/distinct.html" class="external-link">distinct</a></span><span class="op">(</span><span class="va">person_id</span>, <span class="va">survey_datetime</span><span class="op">)</span></span></code></pre></div>
<p>And this code would start with the all of us specific person table
and join that to the survey dates table to incorporate information about
demogrpahics.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">demo</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/tbl.html" class="external-link">tbl</a></span><span class="op">(</span><span class="va">con</span>, <span class="st">"cb_search_person"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">age_at_consent</span> <span class="op">&gt;=</span> <span class="fl">40</span> <span class="op">&amp;</span> <span class="va">age_at_consent</span> <span class="op">&lt;=</span> <span class="fl">120</span>,</span>
<span>         <span class="va">has_ehr_data</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/distinct.html" class="external-link">distinct</a></span><span class="op">(</span><span class="va">person_id</span>, <span class="va">sex_at_birth</span>, <span class="va">dob</span><span class="op">)</span>  <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">inner_join</a></span><span class="op">(</span><span class="va">survey_dates</span>, by <span class="op">=</span> <span class="st">"person_id"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">person_id</span>, <span class="va">sex_at_birth</span>, <span class="va">dob</span>, <span class="va">survey_datetime</span><span class="op">)</span></span></code></pre></div>
<p>We could leave this as a query, or we could pull the data into our
local session:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">demo_collected</span> <span class="op">&lt;-</span> <span class="va">demo</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/compute.html" class="external-link">collect</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>If I wanted to save this data to my bucket, I would use
<code><a href="https://rdrr.io/r/utils/write.table.html" class="external-link">write.csv()</a></code> and then <code>aou_save_to_bucket()</code></p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/write.table.html" class="external-link">write.csv</a></span><span class="op">(</span><span class="va">demo_collected</span>, <span class="st">"demo.csv"</span>, row.names <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="fu">aou_save_to_bucket</span><span class="op">(</span><span class="st">"demo.csv"</span><span class="op">)</span></span></code></pre></div>
<p>If you want to know more about the tables available in AllofUs - read
through the data dictionaries linked above.</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

      </div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Louisa Smith, Rob Cavanaugh.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
