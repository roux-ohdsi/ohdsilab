<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Introduction to ohdsilab (start here!) • ohdsilab</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet">
<meta property="og:title" content="Introduction to ohdsilab (start here!)">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-black" data-bs-theme="dark" aria-label="Site navigation"><div class="container">
    <div style="height:40px;display:inline;margin:0 10px;"><a href="https://ohdsi.northeastern.edu/" class="external-link"><img src="logo.png" style="width:auto;height:100%;"></a></div>
    <a class="navbar-brand me-2" href="../index.html">ohdsilab</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/01-intro-to-ohdsilab.html">Introduction to ohdsilab (start here!)</a></li>
    <li><a class="dropdown-item" href="../articles/02-getting-started-with-box.html">Getting Started with the OHDSI-Lab Box</a></li>
    <li><a class="dropdown-item" href="../articles/03-Generating-a-cohort.html">Generating a cohort</a></li>
    <li><a class="dropdown-item" href="../articles/04-Generating-a-cohort-with_Capr.html">Generating a cohort with Capr</a></li>
    <li><a class="dropdown-item" href="../articles/05-feature-extraction-covariates.html">Generating Covariates and Table 1</a></li>
    <li><a class="dropdown-item" href="../articles/06-feature-extraction-characterization.html">Generating Characterization Files</a></li>
    <li><a class="dropdown-item" href="../articles/07-working-with-omop-cdm.html">Working with Data from the ohdsilab database</a></li>
    <li><a class="dropdown-item" href="../articles/08-CohortExplorer.html">Visualizing Sample Data</a></li>
    <li><a class="dropdown-item" href="../articles/09-PatientLevelPrediction.html">Patient Level Prediction</a></li>
    <li><a class="dropdown-item" href="../articles/10-Eunomia.html">Generating a Synthetic Dataset</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/roux-ohdsi/ohdsilab/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Introduction to ohdsilab (start here!)</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/roux-ohdsi/ohdsilab/blob/HEAD/vignettes/01-intro-to-ohdsilab.Rmd" class="external-link"><code>vignettes/01-intro-to-ohdsilab.Rmd</code></a></small>
      <div class="d-none name"><code>01-intro-to-ohdsilab.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>As a first step for using ohdsilab in R, please work through the code
in this vignette line by line. It will give you some familiarity with
the setup process and querying the data. It also includes important tips
on using R and ohdsilab, which might differ from a typical workflow for
using R. You’ll want to have the email you received when you first
created your box handy, as it has your credentials in it.</p>
</div>
<div class="section level2">
<h2 id="starting-a-new-project">Starting a new project<a class="anchor" aria-label="anchor" href="#starting-a-new-project"></a>
</h2>
<p>Once you’ve created your workspace (i.e., your virtual computer) from
the ohdsilab dashboard, and logged into your computer on the Amazon
Workspaces App, you’re ready to get started using R to query the
database.</p>
<div style="border: solid black; padding:1%; margin: 5% 3%;box-shadow: 5px 5px #FF6A74CC;">
<p><strong>R Projects and {renv}</strong></p>
<p>There are two important (maybe even necessary) steps for using R in
the OHDSI Lab. The first is to use a project-oriented workflow. If
you’re new to R-projects and a project-oriented workflow, go read <a href="https://www.tidyverse.org/blog/2017/12/workflow-vs-script/" class="external-link">this
article</a>. You can find more details about projects here: <a href="https://r4ds.had.co.nz/workflow-projects.html" class="external-link uri">https://r4ds.had.co.nz/workflow-projects.html</a>. The
second is to use {renv} to manage package versions within your R
projects. This R package, setup guide and the other vignettes assume
that you are using these two steps.</p>
</div>
<p>After opening RStudio, begin by going to <code>File</code> and select
<code>New Project</code>. Give the project a name and select in your
preferred location using the <code>browse</code> button. Make sure to
check the box that says <code>Use renv with this project</code>. No
problem if you accidentally skip this step, you can still activate
{renv} by running <code><a href="https://rstudio.github.io/renv/reference/activate.html" class="external-link">renv::activate()</a></code> as the first thing you
do in your new project.</p>
</div>
<div class="section level2">
<h2 id="installing-packages">Installing Packages<a class="anchor" aria-label="anchor" href="#installing-packages"></a>
</h2>
<p><strong><em>We strongly recommend using the {renv} R package to
install ohdsilab and all other packages on your OHDSI-Lab Box/Workspace.
Installing packages without {renv} is likely to fail due to permission
restrictions.</em></strong></p>
<p>A guide to using {renv} is here: <a href="https://rstudio.github.io/renv/articles/renv.html" class="external-link uri">https://rstudio.github.io/renv/articles/renv.html</a>.</p>
<p>The first thing you should do is update renv. To do this, run the
following code in your console.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">renv</span><span class="fu">::</span><span class="fu"><a href="https://rstudio.github.io/renv/reference/upgrade.html" class="external-link">upgrade</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>Then, you can install the ohdsilab package from Github like this:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">renv</span><span class="fu">::</span><span class="fu"><a href="https://rstudio.github.io/renv/reference/install.html" class="external-link">install</a></span><span class="op">(</span><span class="st">"roux-ohdsi/ohdsilab"</span><span class="op">)</span></span></code></pre></div>
<p>If you want to also install OHDSI packages (e.g., DatabaseConnector),
set dependencies = “Suggests”. This is recommended unless you are
working on the AllofUs Researcher workbench as these packages take a
while to install and are not terribly useful with the AllofUs database
setup.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">renv</span><span class="fu">::</span><span class="fu"><a href="https://rstudio.github.io/renv/reference/install.html" class="external-link">install</a></span><span class="op">(</span><span class="st">"roux-ohdsi/ohdsilab"</span>, dependencies <span class="op">=</span> <span class="st">"Suggests"</span><span class="op">)</span></span></code></pre></div>
<p>You can also install and update regular packages from CRAN:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">renv</span><span class="fu">::</span><span class="fu"><a href="https://rstudio.github.io/renv/reference/install.html" class="external-link">install</a></span><span class="op">(</span><span class="st">"dplyr"</span><span class="op">)</span></span></code></pre></div>
<p>You may notice that trying to install packages without using {renv}
results in errors that indicate that you don’t have permission to
install R packages. This is not the case - you are free to install R
packages on your virtual computer/workspace - but you should use {renv}
to do is.</p>
</div>
<div class="section level2">
<h2 id="load-the-ohdsilab-package">Load the ohdsilab package<a class="anchor" aria-label="anchor" href="#load-the-ohdsilab-package"></a>
</h2>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://roux-ohdsi.github.io/ohdsilab/" class="external-link">ohdsilab</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org" class="external-link">tidyverse</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ohdsi.github.io/DatabaseConnector/" class="external-link">DatabaseConnector</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://keyring.r-lib.org/" class="external-link">keyring</a></span><span class="op">)</span></span></code></pre></div>
<p><em><code><a href="https://roux-ohdsi.github.io/ohdsilab/" class="external-link">library(ohdsilab)</a></code> should also load
{DatabaseConnector}, {keyring}, and other dependencies, but you might
want to explicitly load them for transparency.</em></p>
</div>
<div class="section level2">
<h2 id="setting-up-your-credentials">Setting up your credentials<a class="anchor" aria-label="anchor" href="#setting-up-your-credentials"></a>
</h2>
<p>There are two sets of credentials you’ll want to set up to make
accessing the data and ATLAS easier. These credentials are in an email
you received when you first created your workspace.</p>
<p>First, set your credentials for the amazon redshift database (db).
These credentials can be found in the email you received when you first
launched the workspace next to “Amazon Redshift Username:” and “Amazon
Redshift Password:” respectively.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">keyring</span><span class="fu">::</span><span class="fu"><a href="https://keyring.r-lib.org/reference/key_get.html" class="external-link">key_set</a></span><span class="op">(</span><span class="st">"db_username"</span><span class="op">)</span></span>
<span><span class="fu">keyring</span><span class="fu">::</span><span class="fu"><a href="https://keyring.r-lib.org/reference/key_get.html" class="external-link">key_set</a></span><span class="op">(</span><span class="st">"db_password"</span><span class="op">)</span></span></code></pre></div>
<p>You can call these variables anything you’d like. They save your
username and password in the background so that you can access your
username and password quickly. For example, try running the following
after setting up your username.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">keyring</span><span class="fu">::</span><span class="fu"><a href="https://keyring.r-lib.org/reference/key_get.html" class="external-link">key_get</a></span><span class="op">(</span><span class="st">"db_username"</span><span class="op">)</span></span></code></pre></div>
<p>You should also set up your ATLAS credentials, as they may be
different than your redshift database credentials. These credentials can
also be found in the email you received when you first launchedyour
workspace next to “ATLAS Username:” and “ATLAS Password:”
respectively.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">keyring</span><span class="fu">::</span><span class="fu"><a href="https://keyring.r-lib.org/reference/key_get.html" class="external-link">key_set</a></span><span class="op">(</span><span class="st">"atlas_username"</span><span class="op">)</span></span>
<span><span class="fu">keyring</span><span class="fu">::</span><span class="fu"><a href="https://keyring.r-lib.org/reference/key_get.html" class="external-link">key_set</a></span><span class="op">(</span><span class="st">"atlas_password"</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="connecting-to-a-database">Connecting to a database<a class="anchor" aria-label="anchor" href="#connecting-to-a-database"></a>
</h2>
<p>You’ll use the {DatabaseConnector} package to connect to the
database. You will also need to download the Amazon Redshift JDBC
driver. To do so, complete the following steps within your OHDSI Lab
Workstation:</p>
<ul>
<li>Navigate to the <a href="https://docs.aws.amazon.com/redshift/latest/mgmt/jdbc20-download-driver.html" class="external-link">Amazon
Redshift JDBC download page</a>.</li>
<li>Click “JDBC 4.2–compatible driver version 2.1 and AWS SDK
driver–dependent libraries” to start the download.</li>
<li>Move the JDBC zip file to a directory of your choosing.</li>
<li>Right-click on the zip file, and select “Extract” to unzip it.</li>
</ul>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Schema Information ===========================================================</span></span>
<span><span class="va">cdm_schema</span> <span class="op">=</span> <span class="st">"omop_cdm_53_pmtx_202203"</span></span>
<span><span class="va">write_schema</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"work_"</span>, <span class="fu">keyring</span><span class="fu">::</span><span class="fu"><a href="https://keyring.r-lib.org/reference/key_get.html" class="external-link">key_get</a></span><span class="op">(</span><span class="st">"db_username"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Set the path to the JDBC driver you installed above</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Sys.setenv.html" class="external-link">Sys.setenv</a></span><span class="op">(</span><span class="st">"DATABASECONNECTOR_JAR_FOLDER"</span> <span class="op">=</span> <span class="st">"insert path to jdbc driver here"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Create the connection</span></span>
<span><span class="va">con</span> <span class="op">=</span>  <span class="fu">DatabaseConnector</span><span class="fu">::</span><span class="fu"><a href="https://ohdsi.github.io/DatabaseConnector/reference/connect.html" class="external-link">connect</a></span><span class="op">(</span></span>
<span>  dbms <span class="op">=</span> <span class="st">"redshift"</span>,</span>
<span>  server <span class="op">=</span> <span class="st">"ohdsi-lab-redshift-cluster-prod.clsyktjhufn7.us-east-1.redshift.amazonaws.com/ohdsi_lab"</span>,</span>
<span>  port <span class="op">=</span> <span class="fl">5439</span>,</span>
<span>  user <span class="op">=</span> <span class="fu">keyring</span><span class="fu">::</span><span class="fu"><a href="https://keyring.r-lib.org/reference/key_get.html" class="external-link">key_get</a></span><span class="op">(</span><span class="st">"db_username"</span><span class="op">)</span>,</span>
<span>  password <span class="op">=</span> <span class="fu">keyring</span><span class="fu">::</span><span class="fu"><a href="https://keyring.r-lib.org/reference/key_get.html" class="external-link">key_get</a></span><span class="op">(</span><span class="st">"db_password"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Test if the connection words</span></span>
<span><span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Logic.html" class="external-link">isTRUE</a></span><span class="op">(</span><span class="fu">DatabaseConnector</span><span class="fu">::</span><span class="fu">dbIsValid</span><span class="op">(</span><span class="va">con</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">{</span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="st">"Connected Successfully"</span><span class="op">)</span><span class="op">}</span></span>
<span></span>
<span><span class="co"># make it easier for some r functions to find the database</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">options</a></span><span class="op">(</span>con.default.value <span class="op">=</span> <span class="va">con</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">options</a></span><span class="op">(</span>schema.default.value <span class="op">=</span> <span class="va">cdm_schema</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">options</a></span><span class="op">(</span>write_schema.default.value <span class="op">=</span> <span class="va">write_schema</span><span class="op">)</span></span></code></pre></div>
<p>Instead of including this at the top of your script, you can also use
a shortcut function in from the ohdsilab package, which will do the same
thing.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">con</span> <span class="op">&lt;-</span> <span class="fu">ohdsilab</span><span class="fu">::</span><span class="fu"><a href="../reference/ohdsilab_connect.html">ohdsilab_connect</a></span><span class="op">(</span></span>
<span>    username <span class="op">=</span> <span class="fu"><a href="https://keyring.r-lib.org/reference/key_get.html" class="external-link">key_get</a></span><span class="op">(</span><span class="st">"db_username"</span><span class="op">)</span>,</span>
<span>    password <span class="op">=</span> <span class="fu"><a href="https://keyring.r-lib.org/reference/key_get.html" class="external-link">key_get</a></span><span class="op">(</span><span class="st">"db_password"</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="querying-the-database">Querying the database<a class="anchor" aria-label="anchor" href="#querying-the-database"></a>
</h2>
<p>The ohdsilab pharmetrics database uses amazon redshift SQL and the
OMOP CDM version 5.3.</p>
<p>You can see information in the 5.3 OMOP version here: <a href="https://ohdsi.github.io/CommonDataModel/cdm53.html" class="external-link uri">https://ohdsi.github.io/CommonDataModel/cdm53.html</a>. The
database organization looks like this (this is a very similar OMOP CDM
5.4 - there are only very minor differences).</p>
<p><img src="https://ohdsi.github.io/CommonDataModel/images/cdm54.png" width="100%"></p>
<p>A more comprehensive diagram with information about the columns in
each of the tables can be found here: <a href="https://lucid.app/lucidchart/dc75ba24-cbb6-4152-9528-a1f67b4b3843/view?page=0_0&amp;invitationId=inv_d9040d51-a9b0-4d91-b3e5-f2f0ce927cf7#" class="external-link uri">https://lucid.app/lucidchart/dc75ba24-cbb6-4152-9528-a1f67b4b3843/view?page=0_0&amp;invitationId=inv_d9040d51-a9b0-4d91-b3e5-f2f0ce927cf7#</a></p>
<p>The data help in the database is stored under the cdm schema You can
think of a schema as kind of like a subfolder in the database. So the
pharmetrics data is stored in ohdsilab/omop_cdm_53_pmtx_202203/… where
the … indicates what table you’re interested in.</p>
<p>To query a table in pharmetrics you might write a line of code like
this:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/tbl.html" class="external-link">tbl</a></span><span class="op">(</span></span>
<span>    <span class="va">con</span>,</span>
<span>    <span class="fu">DatabaseConnector</span><span class="fu">::</span><span class="fu"><a href="https://ohdsi.github.io/DatabaseConnector/reference/inDatabaseSchema.html" class="external-link">inDatabaseSchema</a></span><span class="op">(</span><span class="st">"omop_cdm_53_pmtx_202203"</span>, <span class="st">"concept"</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<p>This code is looking for the concept table in the pharmetrics schema
which is in the ohdsilab database. You can also see the concept table in
the orange box labelled “Standardized Vocabularies” in the picture
above.</p>
<p>You also have your own schema (sometimes called your “scratchpad”)
where you can save information pertinent to your studies. If you were
usr999, you could access a table (that you have previously created) like
this:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># note - this wont actually work! the table doesn't exist</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/tbl.html" class="external-link">tbl</a></span><span class="op">(</span></span>
<span>      <span class="va">con</span>,</span>
<span>      <span class="fu">DatabaseConnector</span><span class="fu">::</span><span class="fu"><a href="https://ohdsi.github.io/DatabaseConnector/reference/inDatabaseSchema.html" class="external-link">inDatabaseSchema</a></span><span class="op">(</span><span class="st">"usr999"</span>, <span class="st">"myCohort"</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span></code></pre></div>
<p>Because both of these tables are in the database, we can connect them
together. For example, you might use {cohortGenerator} to generate a
cohort table in your schema (“myCohort”). Your cohort table includes a
column of person_id’s (and some other information) that you can use to
reduce the giant amount of data in pharmetrics - usually with an
<code>inner_join</code>.</p>
<p>(See <a href="https://ohdsi.github.io/CohortGenerator/articles/GeneratingCohorts.html" class="external-link uri">https://ohdsi.github.io/CohortGenerator/articles/GeneratingCohorts.html</a>
for a tutorial)</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/tbl.html" class="external-link">tbl</a></span><span class="op">(</span></span>
<span>    <span class="va">con</span>,</span>
<span>    <span class="fu">DatabaseConnector</span><span class="fu">::</span><span class="fu"><a href="https://ohdsi.github.io/DatabaseConnector/reference/inDatabaseSchema.html" class="external-link">inDatabaseSchema</a></span><span class="op">(</span><span class="st">"usr999"</span>, <span class="st">"myCohort"</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">inner_join</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/tbl.html" class="external-link">tbl</a></span><span class="op">(</span></span>
<span>      <span class="va">con</span>,</span>
<span>      <span class="fu">DatabaseConnector</span><span class="fu">::</span><span class="fu"><a href="https://ohdsi.github.io/DatabaseConnector/reference/inDatabaseSchema.html" class="external-link">inDatabaseSchema</a></span><span class="op">(</span><span class="st">"omop_cdm_53_pmtx_202203"</span>, <span class="st">"person"</span><span class="op">)</span></span>
<span>    <span class="op">)</span>,</span>
<span>    by <span class="op">=</span> <span class="st">"person_id"</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<p>Remembering the name of the database schema and your usr schema can
be a bit annoying. That’s why you should get in the habit of saving the
schema names as variables at the top of your scripts, so you can just
reference these strings using the variables <code>cdm_schema</code> and
<code>write_schema</code>.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cdm_schema</span> <span class="op">=</span> <span class="st">"omop_cdm_53_pmtx_202203"</span></span>
<span><span class="va">write_schema</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"work_"</span>, <span class="fu">keyring</span><span class="fu">::</span><span class="fu"><a href="https://keyring.r-lib.org/reference/key_get.html" class="external-link">key_get</a></span><span class="op">(</span><span class="st">"db_username"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>It might look like this:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/tbl.html" class="external-link">tbl</a></span><span class="op">(</span></span>
<span>    <span class="va">con</span>,</span>
<span>    <span class="fu">DatabaseConnector</span><span class="fu">::</span><span class="fu"><a href="https://ohdsi.github.io/DatabaseConnector/reference/inDatabaseSchema.html" class="external-link">inDatabaseSchema</a></span><span class="op">(</span><span class="va">write_schema</span>, <span class="st">"myCohort"</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">inner_join</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/tbl.html" class="external-link">tbl</a></span><span class="op">(</span></span>
<span>      <span class="va">con</span>,</span>
<span>      <span class="fu">DatabaseConnector</span><span class="fu">::</span><span class="fu"><a href="https://ohdsi.github.io/DatabaseConnector/reference/inDatabaseSchema.html" class="external-link">inDatabaseSchema</a></span><span class="op">(</span><span class="va">cdm_schema</span>, <span class="st">"person"</span><span class="op">)</span></span>
<span>    <span class="op">)</span>,</span>
<span>    by <span class="op">=</span> <span class="st">"person_id"</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<p>This can still be quite a bit of code for each join. Additionally,
there are some known bugs with using the dplyr *_join functions with our
redshift database isntances. For these reasons, we recommend that you
use the <code><a href="../reference/omop_join.html">ohdsilab::omop_join()</a></code> function can help streamline
your code. It’s a wrapper for the dplyr <code>join</code> functions that
also includes some workarounds for a few known bugs in the backround so
that you don’t have to worry about them as much.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/tbl.html" class="external-link">tbl</a></span><span class="op">(</span></span>
<span>    <span class="va">con</span>,</span>
<span>    <span class="fu">DatabaseConnector</span><span class="fu">::</span><span class="fu"><a href="https://ohdsi.github.io/DatabaseConnector/reference/inDatabaseSchema.html" class="external-link">inDatabaseSchema</a></span><span class="op">(</span><span class="va">write_schema</span>, <span class="st">"myCohort"</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">ohdsilab</span><span class="fu">::</span><span class="fu"><a href="../reference/omop_join.html">omop_join</a></span><span class="op">(</span><span class="st">"person"</span>, type <span class="op">=</span> <span class="st">"inner"</span>, by <span class="op">=</span> <span class="st">"person_id"</span><span class="op">)</span></span></code></pre></div>
<p>It works because we set the default connection and cdm_schema using
these lines of code from the ohdsi_new_script snippet. The
<code><a href="../reference/omop_join.html">omop_join()</a></code> function will look for these defaults first,
and if it doesn’t find them (because you didn’t run these two lines),
will let you know you need to provide them directly. Note that if you
want to point omop_join() to your user scratchpad, you only need to set
<code>schema = write_schema</code>.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">options</a></span><span class="op">(</span>con.default.value <span class="op">=</span> <span class="va">con</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">options</a></span><span class="op">(</span>schema.default.value <span class="op">=</span> <span class="va">cdm_schema</span><span class="op">)</span></span></code></pre></div>
<p>Here’s a toy example of how we can put all this information together.
We can extract all conditions for women born in 2002. Try to run these
chunks to make sure everything is working.</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Start with a pointer to a table in the database. It could be in the cdm_schema</span></span>
<span><span class="co"># or in your user write_schema.</span></span>
<span><span class="va">female_2002</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/tbl.html" class="external-link">tbl</a></span><span class="op">(</span><span class="va">con</span>, <span class="fu"><a href="https://ohdsi.github.io/DatabaseConnector/reference/inDatabaseSchema.html" class="external-link">inDatabaseSchema</a></span><span class="op">(</span><span class="va">cdm_schema</span>, <span class="st">"person"</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>    <span class="co"># filter the data for women born in 2002</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">year_of_birth</span> <span class="op">==</span> <span class="fl">2002</span>, <span class="va">gender_source_value</span> <span class="op">==</span> <span class="st">"F"</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>    <span class="co"># select only the necessary columns</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">person_id</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>    <span class="co"># join to the condition occurrence table using an inner join</span></span>
<span>    <span class="fu"><a href="../reference/omop_join.html">omop_join</a></span><span class="op">(</span><span class="st">"condition_occurrence"</span>, type <span class="op">=</span> <span class="st">"inner"</span>, by <span class="op">=</span> <span class="st">"person_id"</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># run to see a preview of the top 10 rows</span></span>
<span><span class="va">female_2002</span></span></code></pre></div>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># how many rows are in our data?</span></span>
<span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/count.html" class="external-link">tally</a></span><span class="op">(</span><span class="va">female_2002</span><span class="op">)</span></span></code></pre></div>
<p>If you get an error from the database, you often will need to
“rollback” before running a new command. The error that tells you that
you need to “rollback” usually looks like this:</p>
<pre><code>Error in `db_query_fields.DBIConnection()`:
! Can't query fields.
Caused by error in `.createErrorReport()`:
! Error executing SQL:
com.amazon.redshift.util.RedshiftException: ERROR: current transaction is 
aborted, commands ignored until end of transaction block
An error report has been created at .../errorReportSql.txt
Run `rlang::last_trace()` to see where the error occurred.</code></pre>
<p>A rollback is essentially like going back in time to a world before
you ran the chunk of code that caused an error. You can easily do this
using ohdsilab provided you’ve set the connection and schema default
values above.</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">ohdsilab</span><span class="fu">::</span><span class="fu"><a href="../reference/rb.html">rb</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>This is synonymous with running.</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ohdsi.github.io/DatabaseConnector/reference/executeSql.html" class="external-link">executeSql</a></span><span class="op">(</span><span class="va">con</span>, <span class="st">"ROLLBACK;"</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="summary">Summary<a class="anchor" aria-label="anchor" href="#summary"></a>
</h2>
<p>If you’re able to connect to the database and run a few basic queries
- you should be good to go. Next, check out some of the other articles
on this website. You might also want to browse Athena (<a href="https://athena.ohdsi.org/" class="external-link uri">https://athena.ohdsi.org/</a>) to start thinking about how
your area of interest is represented in OMOP. There are also lots of
videos on using the OMOP CDM on youtube (<a href="https://www.youtube.com/@OHDSI" class="external-link uri">https://www.youtube.com/@OHDSI</a>).</p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Louisa Smith, Rob Cavanaugh.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
