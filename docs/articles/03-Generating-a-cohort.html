<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Generating a cohort • ohdsilab</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet">
<meta property="og:title" content="Generating a cohort">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-black" data-bs-theme="dark" aria-label="Site navigation"><div class="container">
    <div style="height:40px;display:inline;margin:0 10px;"><a href="https://ohdsi.northeastern.edu/" class="external-link"><img src="logo.png" style="width:auto;height:100%;"></a></div>
    <a class="navbar-brand me-2" href="../index.html">ohdsilab</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/01-intro-to-ohdsilab.html">Introduction to ohdsilab (start here!)</a></li>
    <li><a class="dropdown-item" href="../articles/02-getting-started-with-box.html">Getting Started with the OHDSI-Lab Box</a></li>
    <li><a class="dropdown-item" href="../articles/03-Generating-a-cohort.html">Generating a cohort</a></li>
    <li><a class="dropdown-item" href="../articles/03.5-Generating-a-cohort-with_Capr.html">Generating a cohort with Capr</a></li>
    <li><a class="dropdown-item" href="../articles/04-feature-extraction-covariates.html">Generating Covariates and Table 1</a></li>
    <li><a class="dropdown-item" href="../articles/05-working-with-omop-cdm.html">Working with Data from the ohdsilab database</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/roux-ohdsi/ohdsilab/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Generating a cohort</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/roux-ohdsi/ohdsilab/blob/HEAD/vignettes/03-Generating-a-cohort.Rmd" class="external-link"><code>vignettes/03-Generating-a-cohort.Rmd</code></a></small>
      <div class="d-none name"><code>03-Generating-a-cohort.Rmd</code></div>
    </div>

    
    
<p>This is a quick tutorial on using a cohort created using ATLAS and
saving cohort IDs and entry/exit in your user schema. This tutorial will
use a cohort created from the SynPuf synthetic dataset, using the cohort
definition “[RC] CVA Ischemic or Hemorrhagic with admission - synpuf”.
This cohort definition imported a phenotype for CVA from stroke ischemic
or Hemorrhagic with admission from Phenotype library (<a href="https://data.ohdsi.org/PhenotypeLibrary/" class="external-link uri">https://data.ohdsi.org/PhenotypeLibrary/</a>). More details
on generating cohorts can be found here: <a href="https://ohdsi.github.io/CohortGenerator/" class="external-link uri">https://ohdsi.github.io/CohortGenerator/</a> and here: <a href="https://ohdsi.github.io/TheBookOfOhdsi/Cohorts.html" class="external-link uri">https://ohdsi.github.io/TheBookOfOhdsi/Cohorts.html</a>.</p>
<p>We’ll need to install two new packages: the OHDSI Web Api and
cohortGenerator</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">remotes</span><span class="fu">::</span><span class="fu"><a href="https://remotes.r-lib.org/reference/install_github.html" class="external-link">install_github</a></span><span class="op">(</span><span class="st">"OHDSI/ROhdsiWebApi"</span><span class="op">)</span></span>
<span><span class="fu">remotes</span><span class="fu">::</span><span class="fu"><a href="https://remotes.r-lib.org/reference/install_github.html" class="external-link">install_github</a></span><span class="op">(</span><span class="st">"OHDSI/CohortGenerator"</span><span class="op">)</span></span></code></pre></div>
<p>We’ll use the same set up code as the intro vignette.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># ==============================================================================</span></span>
<span><span class="co"># Packages =====================================================================</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://keyring.r-lib.org/" class="external-link">keyring</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ohdsi.github.io/DatabaseConnector/" class="external-link">DatabaseConnector</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org" class="external-link">tidyverse</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://roux-ohdsi.github.io/ohdsilab/" class="external-link">ohdsilab</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ohdsi.github.io/ROhdsiWebApi/" class="external-link">ROhdsiWebApi</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ohdsi.github.io/CohortGenerator/" class="external-link">CohortGenerator</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># DB Connections ===============================================================</span></span>
<span><span class="va">atlas_url</span> <span class="op">=</span> <span class="st">"https://atlas.roux-ohdsi-prod.aws.northeastern.edu/WebAPI"</span></span>
<span><span class="va">cdm_schema</span> <span class="op">=</span> <span class="st">"omop_cdm_53_pmtx_202203"</span></span>
<span><span class="va">synpuf_schema</span> <span class="op">=</span> <span class="st">"omop_cdm_synpuf_110k_531"</span></span>
<span><span class="va">write_schema</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"work_"</span>, <span class="fu">keyring</span><span class="fu">::</span><span class="fu"><a href="https://keyring.r-lib.org/reference/key_get.html" class="external-link">key_get</a></span><span class="op">(</span><span class="st">"db_username"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Instead of creating a database connection, we’re just going to create
a set of connection details. Some of the OHDSI R packages use this
connectionDetails method instead of using a connection.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Create connection details</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Sys.setenv.html" class="external-link">Sys.setenv</a></span><span class="op">(</span><span class="st">"DATABASECONNECTOR_JAR_FOLDER"</span> <span class="op">=</span> <span class="st">"insert path to jdbc driver here"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">connectionDetails</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ohdsi.github.io/DatabaseConnector/reference/createConnectionDetails.html" class="external-link">createConnectionDetails</a></span><span class="op">(</span>dbms <span class="op">=</span> <span class="st">"redshift"</span>,</span>
<span>                                             server <span class="op">=</span> <span class="st">"ohdsi-lab-redshift-cluster-prod.clsyktjhufn7.us-east-1.redshift.amazonaws.com/ohdsi_lab"</span>,</span>
<span>                                             port <span class="op">=</span> <span class="fl">5439</span>,</span>
<span>                                             user <span class="op">=</span> <span class="fu">keyring</span><span class="fu">::</span><span class="fu"><a href="https://keyring.r-lib.org/reference/key_get.html" class="external-link">key_get</a></span><span class="op">(</span><span class="st">"db_username"</span><span class="op">)</span>,</span>
<span>                                             password <span class="op">=</span> <span class="fu">keyring</span><span class="fu">::</span><span class="fu"><a href="https://keyring.r-lib.org/reference/key_get.html" class="external-link">key_get</a></span><span class="op">(</span><span class="st">"db_password"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co"># make it easier for some r functions to find the database</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">options</a></span><span class="op">(</span>con.default.value <span class="op">=</span> <span class="va">con</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">options</a></span><span class="op">(</span>schema.default.value <span class="op">=</span> <span class="va">cdm_schema</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">options</a></span><span class="op">(</span>write_schema.default.value <span class="op">=</span> <span class="va">write_schema</span><span class="op">)</span></span></code></pre></div>
<p>We’re also going to authorize the api for accessing ATLAS from R.
This uses the atlas_url information, and your username/password which
you set using <code><a href="https://keyring.r-lib.org/reference/key_get.html" class="external-link">keyring::key_set()</a></code> in a previous vignette
(“Introduction to OHDSI Lab”).</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">ROhdsiWebApi</span><span class="fu">::</span><span class="fu"><a href="https://ohdsi.github.io/ROhdsiWebApi/reference/authorizeWebApi.html" class="external-link">authorizeWebApi</a></span><span class="op">(</span><span class="va">atlas_url</span>, </span>
<span>                              authMethod <span class="op">=</span> <span class="st">"db"</span>, </span>
<span>                              webApiUsername <span class="op">=</span> <span class="fu">keyring</span><span class="fu">::</span><span class="fu"><a href="https://keyring.r-lib.org/reference/key_get.html" class="external-link">key_get</a></span><span class="op">(</span><span class="st">"atlas_username"</span><span class="op">)</span>, </span>
<span>                              webApiPassword <span class="op">=</span> <span class="fu">keyring</span><span class="fu">::</span><span class="fu"><a href="https://keyring.r-lib.org/reference/key_get.html" class="external-link">key_get</a></span><span class="op">(</span><span class="st">"atlas_password"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Ok now we need to do two things. First - pick which cohort to use to
generate a data set. This is the number for the cohort that you (or
someone else) creates in ATLAS. Note that if you want to include
multiple cohorts in the same table, you can provide a vector of cohort
ID numbers.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cohortId</span> <span class="op">&lt;-</span> <span class="fl">1124</span></span></code></pre></div>
<p>Then we’re going to create a cohortDefinitionSet object using that ID
and the baseUrl.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cohortDefinitionSet</span> <span class="op">&lt;-</span> <span class="fu">ROhdsiWebApi</span><span class="fu">::</span><span class="fu"><a href="https://ohdsi.github.io/ROhdsiWebApi/reference/exportCohortDefinitionSet.html" class="external-link">exportCohortDefinitionSet</a></span><span class="op">(</span>baseUrl <span class="op">=</span> <span class="va">atlas_url</span>,</span>
<span>                                                               cohortIds <span class="op">=</span> <span class="va">cohortId</span><span class="op">)</span></span>
<span></span>
<span><span class="va">cohortDefinitionSet</span></span></code></pre></div>
<p>We’ll create a name for this cohort - this is the name that’s used
for the tables in your user schema.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cohortTableNames</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ohdsi.github.io/CohortGenerator/reference/getCohortTableNames.html" class="external-link">getCohortTableNames</a></span><span class="op">(</span>cohortTable <span class="op">=</span> <span class="st">"synPuf_CVA"</span><span class="op">)</span></span>
<span><span class="va">cohortTableNames</span></span></code></pre></div>
<p>We’ll create empty tables to receive this data. We’re using the
connectionDetails object, the cohortTableName object, and the mySchema
object from above.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># create empty tables in the {mySchema}.cohort table</span></span>
<span><span class="fu"><a href="https://ohdsi.github.io/CohortGenerator/reference/createCohortTables.html" class="external-link">createCohortTables</a></span><span class="op">(</span>connectionDetails <span class="op">=</span> <span class="va">connectionDetails</span>,</span>
<span>                   cohortTableNames <span class="op">=</span> <span class="va">cohortTableNames</span>,</span>
<span>                   cohortDatabaseSchema <span class="op">=</span> <span class="va">write_schema</span><span class="op">)</span></span></code></pre></div>
<p><em>This function doesn’t actually currently work in Rmarkdown, see
<a href="https://github.com/OHDSI/CohortGenerator/issues/97" class="external-link uri">https://github.com/OHDSI/CohortGenerator/issues/97</a> for
details. If you need to use it in RMarkdown supposedly you can wrap it
in <code>purrr:quietly()</code></em></p>
<p>Finally, we’ll add everyone from the database to our cohort. Notice
that this code references the synpuf schema. If you were working with
the pharmetrics data, you’d reference <code>cdm_schema</code> or
<code>"omop_cdm_53_pmtx_202203"</code>.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cohortsGenerated</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ohdsi.github.io/CohortGenerator/reference/generateCohortSet.html" class="external-link">generateCohortSet</a></span><span class="op">(</span>connectionDetails <span class="op">=</span> <span class="va">connectionDetails</span>,</span>
<span>                                      cdmDatabaseSchema <span class="op">=</span> <span class="va">synpuf_schema</span>,</span>
<span>                                      cohortDatabaseSchema <span class="op">=</span> <span class="va">write_schema</span>,</span>
<span>                                      cohortTableNames <span class="op">=</span> <span class="va">cohortTableNames</span>,</span>
<span>                                      cohortDefinitionSet <span class="op">=</span> <span class="va">cohortDefinitionSet</span><span class="op">)</span></span></code></pre></div>
<p>If you want to visually see this new table in your schema, you can
connect to the database and use the <strong>Connections</strong> pane in
the top right of RStudio.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">con</span> <span class="op">=</span>  <span class="fu">DatabaseConnector</span><span class="fu">::</span><span class="fu"><a href="https://ohdsi.github.io/DatabaseConnector/reference/connect.html" class="external-link">connect</a></span><span class="op">(</span></span>
<span>  dbms <span class="op">=</span> <span class="st">"redshift"</span>,</span>
<span>  server <span class="op">=</span> <span class="st">"ohdsi-lab-redshift-cluster-prod.clsyktjhufn7.us-east-1.redshift.amazonaws.com/ohdsi_lab"</span>,</span>
<span>  port <span class="op">=</span> <span class="fl">5439</span>,</span>
<span>  user <span class="op">=</span> <span class="fu">keyring</span><span class="fu">::</span><span class="fu"><a href="https://keyring.r-lib.org/reference/key_get.html" class="external-link">key_get</a></span><span class="op">(</span><span class="st">"db_username"</span><span class="op">)</span>,</span>
<span>  password <span class="op">=</span> <span class="fu">keyring</span><span class="fu">::</span><span class="fu"><a href="https://keyring.r-lib.org/reference/key_get.html" class="external-link">key_get</a></span><span class="op">(</span><span class="st">"db_password"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Then, you might use this table (for example) to reduce the full
person table to include only people in your cohort.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># pull data from the new cohort table</span></span>
<span><span class="va">cohort</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/tbl.html" class="external-link">tbl</a></span><span class="op">(</span><span class="va">con</span>, <span class="fu"><a href="https://ohdsi.github.io/DatabaseConnector/reference/inDatabaseSchema.html" class="external-link">inDatabaseSchema</a></span><span class="op">(</span><span class="va">write_schema</span>, <span class="st">"synPuf_CVA"</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span>person_id <span class="op">=</span> <span class="va">subject_id</span>, <span class="va">cohort_start_date</span>, <span class="va">cohort_end_date</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># join to the person table to get information about demographics, calculate age at cohort entry</span></span>
<span><span class="va">demographics</span> <span class="op">&lt;-</span> <span class="va">cohort</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="../reference/omop_join.html">omop_join</a></span><span class="op">(</span><span class="st">"person"</span>, type <span class="op">=</span> <span class="st">"inner"</span>, by <span class="op">=</span> <span class="st">"person_id"</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">person_id</span>, <span class="va">cohort_start_date</span>, <span class="va">cohort_end_date</span>, <span class="va">year_of_birth</span>, gender <span class="op">=</span> <span class="va">gender_source_value</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>age_at_entry <span class="op">=</span> <span class="fu"><a href="https://ohdsi.github.io/DatabaseConnector/reference/year.html" class="external-link">year</a></span><span class="op">(</span><span class="va">cohort_start_date</span><span class="op">)</span> <span class="op">-</span> <span class="va">year_of_birth</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># if the above fails you may need to set the following options again first</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">options</a></span><span class="op">(</span>con.default.value <span class="op">=</span> <span class="va">con</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">options</a></span><span class="op">(</span>schema.default.value <span class="op">=</span> <span class="va">cdm_schema</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">options</a></span><span class="op">(</span>write_schema.default.value <span class="op">=</span> <span class="va">write_schema</span><span class="op">)</span></span></code></pre></div>
<p>This code starts with a table made with CohortGenerator and uses it
to limit the OMOP person table to just the people that we’re interested
in, as defined by our cohort, and then calculates an age at entry.</p>
  </main>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Louisa Smith, Rob Cavanaugh.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
