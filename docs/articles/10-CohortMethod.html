<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Population Level Estimation using CohortMethod • ohdsilab</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="96x96" href="../favicon-96x96.png">
<link rel="icon" type="”image/svg+xml”" href="../favicon.svg">
<link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
<link rel="icon" sizes="any" href="../favicon.ico">
<link rel="manifest" href="../site.webmanifest">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet">
<meta property="og:title" content="Population Level Estimation using CohortMethod">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-black" data-bs-theme="dark" aria-label="Site navigation"><div class="container">
    <div style="height:40px;display:inline;margin:0 10px;"><a href="https://ohdsi.northeastern.edu/" class="external-link"><img src="logo.png" style="width:auto;height:100%;"></a></div>
    <a class="navbar-brand me-2" href="../index.html">ohdsilab</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/01-intro-to-ohdsilab.html">Introduction to ohdsilab (start here!)</a></li>
    <li><a class="dropdown-item" href="../articles/02-getting-started-with-box.html">Getting Started with the OHDSI-Lab Box</a></li>
    <li><a class="dropdown-item" href="../articles/03-Generating-a-cohort.html">Generating a cohort</a></li>
    <li><a class="dropdown-item" href="../articles/04-Generating-a-cohort-with_Capr.html">Generating a cohort with Capr</a></li>
    <li><a class="dropdown-item" href="../articles/05-feature-extraction-covariates.html">Generating Covariates and Table 1</a></li>
    <li><a class="dropdown-item" href="../articles/06-feature-extraction-characterization.html">Generating Characterization Files</a></li>
    <li><a class="dropdown-item" href="../articles/07-working-with-omop-cdm.html">Working with Data from the ohdsilab database</a></li>
    <li><a class="dropdown-item" href="../articles/08-CohortExplorer.html">Visualizing Sample Data</a></li>
    <li><a class="dropdown-item" href="../articles/09-PatientLevelPrediction.html">Patient Level Prediction</a></li>
    <li><a class="dropdown-item" href="../articles/10-CohortMethod.html">Population Level Estimation using CohortMethod</a></li>
    <li><a class="dropdown-item" href="../articles/11-SelfControlledCaseSeries.html">Population Level Estimation using SelfControlledCaseSeries</a></li>
    <li><a class="dropdown-item" href="../articles/12-Eunomia.html">Generating a Synthetic Dataset</a></li>
    <li><a class="dropdown-item" href="../articles/13-Stategus.html">Designing a network analysis using Strategus</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/roux-ohdsi/ohdsilab/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Population Level Estimation using CohortMethod</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/roux-ohdsi/ohdsilab/blob/HEAD/vignettes/10-CohortMethod.Rmd" class="external-link"><code>vignettes/10-CohortMethod.Rmd</code></a></small>
      <div class="d-none name"><code>10-CohortMethod.Rmd</code></div>
    </div>

    
    
<p>This tutorial will illustrate how to use the CohortMethod package
created by the OHDSI community and described here: <a href="https://ohdsi.github.io/CohortMethod/" class="external-link uri">https://ohdsi.github.io/CohortMethod/</a>. Researchers can
use this package to calculate difference of risk of specific clinical
outcomes between a target cohort and a comparator cohort.</p>
<p>The Pharmetrics dataset (containing real patient claims data) will be
used in this tutorial to ensure that correlation between risk of outcome
and presence of outcome is consistent (Synthetic data may not produce
consistent relationships between covariates). Any person-level results
should not be shared with individuals who are not active OHDSI Lab
users.</p>
<p>We’ll need to install one new package: CohortMethod</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">renv</span><span class="fu">::</span><span class="fu"><a href="https://rstudio.github.io/renv/reference/install.html" class="external-link">install</a></span><span class="op">(</span><span class="st">"OHDSI/CohortMethod"</span><span class="op">)</span></span></code></pre></div>
<p>We’ll generate a cohort from ATLAS as we did in vignette 3, except
now we need three cohorts: a target cohort (i.e. the population we’re
analyzing): 4862 (Metformin &amp; insulin exposure with prior type 2
diabetes diagnosis), a comparator cohort (i.e. the population we’re
comparing with the target population): 4859 (Insulin exposure with prior
type 2 diabetes diagnosis), and an outcome cohort (i.e. the outcome
we’re calculating risk for): 4861 (Hypoglycemia).</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#load the necessary packages</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ohdsi.github.io/CohortGenerator/" class="external-link">CohortGenerator</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org" class="external-link">tidyverse</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://keyring.r-lib.org/" class="external-link">keyring</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ohdsi.github.io/CohortMethod" class="external-link">CohortMethod</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ohdsi.github.io/ROhdsiWebApi/" class="external-link">ROhdsiWebApi</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ohdsi.github.io/DatabaseConnector/" class="external-link">DatabaseConnector</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://roux-ohdsi.github.io/ohdsilab/">ohdsilab</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co">#set path to JDBC driver</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Sys.setenv.html" class="external-link">Sys.setenv</a></span><span class="op">(</span><span class="st">"DATABASECONNECTOR_JAR_FOLDER"</span> <span class="op">=</span> <span class="st">"INSERT PATH TO JDBC DRIVER"</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#set database connection details</span></span>
<span><span class="va">connectionDetails</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ohdsi.github.io/DatabaseConnector/reference/createConnectionDetails.html" class="external-link">createConnectionDetails</a></span><span class="op">(</span></span>
<span>    dbms <span class="op">=</span> <span class="st">"redshift"</span>,</span>
<span>    server <span class="op">=</span> <span class="st">"ohdsi-lab-redshift-cluster-prod.clsyktjhufn7.us-east-1.redshift.amazonaws.com/ohdsi_lab"</span>,</span>
<span>    port <span class="op">=</span> <span class="fl">5439</span>,</span>
<span>    user <span class="op">=</span> <span class="fu">keyring</span><span class="fu">::</span><span class="fu"><a href="https://keyring.r-lib.org/reference/key_get.html" class="external-link">key_get</a></span><span class="op">(</span><span class="st">"db_username"</span><span class="op">)</span>,</span>
<span>    password <span class="op">=</span> <span class="fu">keyring</span><span class="fu">::</span><span class="fu"><a href="https://keyring.r-lib.org/reference/key_get.html" class="external-link">key_get</a></span><span class="op">(</span><span class="st">"db_password"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#set atlas url and schema names</span></span>
<span><span class="va">atlas_url</span> <span class="op">=</span> <span class="st">"https://atlas.roux-ohdsi-prod.aws.northeastern.edu/WebAPI"</span></span>
<span><span class="va">cdm_schema</span> <span class="op">=</span> <span class="st">"omop_cdm_53_pmtx_202203"</span></span>
<span><span class="va">write_schema</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"work_"</span>, <span class="fu">keyring</span><span class="fu">::</span><span class="fu"><a href="https://keyring.r-lib.org/reference/key_get.html" class="external-link">key_get</a></span><span class="op">(</span><span class="st">"db_username"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#connect to the ohdsilab database and setting </span></span>
<span><span class="va">con</span> <span class="op">=</span>  <span class="fu">DatabaseConnector</span><span class="fu">::</span><span class="fu"><a href="https://ohdsi.github.io/DatabaseConnector/reference/connect.html" class="external-link">connect</a></span><span class="op">(</span><span class="va">connectionDetails</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#make it easier for some r functions to find the database and schemas</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">options</a></span><span class="op">(</span>con.default.value <span class="op">=</span> <span class="va">con</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">options</a></span><span class="op">(</span>schema.default.value <span class="op">=</span> <span class="va">cdm_schema</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">options</a></span><span class="op">(</span>write_schema.default.value <span class="op">=</span> <span class="va">write_schema</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#establish authorization to connect to ATLAS API</span></span>
<span><span class="fu">ROhdsiWebApi</span><span class="fu">::</span><span class="fu"><a href="https://ohdsi.github.io/ROhdsiWebApi/reference/authorizeWebApi.html" class="external-link">authorizeWebApi</a></span><span class="op">(</span></span>
<span>  <span class="va">atlas_url</span>,</span>
<span>  authMethod <span class="op">=</span> <span class="st">"db"</span>,</span>
<span>  webApiUsername <span class="op">=</span> <span class="fu">keyring</span><span class="fu">::</span><span class="fu"><a href="https://keyring.r-lib.org/reference/key_get.html" class="external-link">key_get</a></span><span class="op">(</span><span class="st">"atlas_username"</span><span class="op">)</span>,</span>
<span>  webApiPassword <span class="op">=</span> <span class="fu">keyring</span><span class="fu">::</span><span class="fu"><a href="https://keyring.r-lib.org/reference/key_get.html" class="external-link">key_get</a></span><span class="op">(</span><span class="st">"atlas_password"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#set the cohort IDs (target, comparator, and outcome)</span></span>
<span><span class="va">cohortIds</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">4859</span>,<span class="fl">4861</span>,<span class="fl">4862</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#extract the cohort definitions from ATLAS</span></span>
<span><span class="va">cohortDefinitionSet</span> <span class="op">&lt;-</span> <span class="fu">ROhdsiWebApi</span><span class="fu">::</span><span class="fu"><a href="https://ohdsi.github.io/ROhdsiWebApi/reference/exportCohortDefinitionSet.html" class="external-link">exportCohortDefinitionSet</a></span><span class="op">(</span></span>
<span>  baseUrl <span class="op">=</span> <span class="va">atlas_url</span>,</span>
<span>  cohortIds <span class="op">=</span> <span class="va">cohortIds</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#set a naming convention for the cohort tables</span></span>
<span><span class="va">cohortTableNames</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ohdsi.github.io/CohortGenerator/reference/getCohortTableNames.html" class="external-link">getCohortTableNames</a></span><span class="op">(</span>cohortTable <span class="op">=</span> <span class="st">"T2D_cohortMethod"</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#create empty tables in your personal schema using the naming convention</span></span>
<span><span class="co">#designated in the last step.</span></span>
<span><span class="fu"><a href="https://ohdsi.github.io/CohortGenerator/reference/createCohortTables.html" class="external-link">createCohortTables</a></span><span class="op">(</span></span>
<span>  connectionDetails <span class="op">=</span> <span class="va">connectionDetails</span>,</span>
<span>  cohortTableNames <span class="op">=</span> <span class="va">cohortTableNames</span>,</span>
<span>  cohortDatabaseSchema <span class="op">=</span> <span class="va">write_schema</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#generate your cohorts for the pmtx database.</span></span>
<span><span class="va">cohortsGenerated</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ohdsi.github.io/CohortGenerator/reference/generateCohortSet.html" class="external-link">generateCohortSet</a></span><span class="op">(</span></span>
<span>  connectionDetails <span class="op">=</span> <span class="va">connectionDetails</span>,</span>
<span>  cdmDatabaseSchema <span class="op">=</span> <span class="va">cdm_schema</span>,</span>
<span>  cohortDatabaseSchema <span class="op">=</span> <span class="va">write_schema</span>,</span>
<span>  cohortTableNames <span class="op">=</span> <span class="va">cohortTableNames</span>,</span>
<span>  cohortDefinitionSet <span class="op">=</span> <span class="va">cohortDefinitionSet</span><span class="op">)</span></span></code></pre></div>
<p>Now we’re ready to start desiging the CohortMethod analysis. First,
we create covariates using Feature Extraction as shown in vignette 6,
making sure to exclude the concept IDs of your study drugs (i.e. the
drugs included in your target and comparator cohorts) and those drugs’
descendant concepts.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">covSettings</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/FeatureExtraction/man/createDefaultCovariateSettings.html" class="external-link">createDefaultCovariateSettings</a></span><span class="op">(</span></span>
<span>  excludedCovariateConceptIds <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">30361</span>,<span class="fl">1503297</span>,<span class="fl">21600713</span>,<span class="fl">21500149</span>,<span class="fl">1992733</span><span class="op">)</span>,</span>
<span>  addDescendantsToExclude <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Extract the relevant data from the database. This may take a
while.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cohortMethodData</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ohdsi.github.io/CohortMethod/reference/getDbCohortMethodData.html" class="external-link">getDbCohortMethodData</a></span><span class="op">(</span></span>
<span>  connectionDetails <span class="op">=</span> <span class="va">connectionDetails</span>,</span>
<span>  cdmDatabaseSchema <span class="op">=</span> <span class="va">cdm_schema</span>,</span>
<span>  targetId <span class="op">=</span> <span class="fl">4862</span>,  <span class="co"># ID for drugA cohort</span></span>
<span>  comparatorId <span class="op">=</span> <span class="fl">4859</span>,  <span class="co"># ID for drugB cohort</span></span>
<span>  outcomeIds <span class="op">=</span> <span class="fl">4861</span>,  <span class="co"># ID for outcome cohort</span></span>
<span>  exposureDatabaseSchema <span class="op">=</span> <span class="va">write_schema</span>,</span>
<span>  exposureTable <span class="op">=</span> <span class="st">"T2D_cohortMethod"</span>,</span>
<span>  outcomeDatabaseSchema <span class="op">=</span> <span class="va">write_schema</span>,</span>
<span>  outcomeTable <span class="op">=</span> <span class="st">"T2D_cohortMethod"</span>,</span>
<span>  covariateSettings <span class="op">=</span> <span class="va">covSettings</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Because the extract takes so long, I recommend saving it in case you
need to come back to the later steps during another session. Once you
have saved the data, reload it as the same variable.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ohdsi.github.io/CohortMethod/reference/saveCohortMethodData.html" class="external-link">saveCohortMethodData</a></span><span class="op">(</span><span class="va">cohortMethodData</span>, <span class="st">"cohortMethodCovariates.zip"</span><span class="op">)</span></span>
<span><span class="va">cohortMethodData</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ohdsi.github.io/CohortMethod/reference/loadCohortMethodData.html" class="external-link">loadCohortMethodData</a></span><span class="op">(</span><span class="st">"cohortMethodCovariates.zip"</span><span class="op">)</span></span></code></pre></div>
<p>Create the study population with the appropriate risk windows. These
can be changed to match the needs of your study.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">studyPop</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ohdsi.github.io/CohortMethod/reference/createStudyPopulation.html" class="external-link">createStudyPopulation</a></span><span class="op">(</span></span>
<span>  cohortMethodData <span class="op">=</span> <span class="va">cohortMethodData</span>,</span>
<span>  outcomeId <span class="op">=</span> <span class="fl">4861</span>,</span>
<span>  firstExposureOnly <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  restrictToCommonPeriod <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  washoutPeriod <span class="op">=</span> <span class="fl">0</span>,</span>
<span>  removeDuplicateSubjects <span class="op">=</span> <span class="st">"keep all"</span>,</span>
<span>  removeSubjectsWithPriorOutcome <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  minDaysAtRisk <span class="op">=</span> <span class="fl">1</span>,</span>
<span>  riskWindowStart <span class="op">=</span> <span class="fl">0</span>,</span>
<span>  startAnchor <span class="op">=</span> <span class="st">"cohort start"</span>,</span>
<span>  riskWindowEnd <span class="op">=</span> <span class="fl">30</span>,</span>
<span>  endAnchor <span class="op">=</span> <span class="st">"cohort end"</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>View attrition (how many subjects were excluded after each bit of
inclusion criteria?):</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ohdsi.github.io/CohortMethod/reference/getAttritionTable.html" class="external-link">getAttritionTable</a></span><span class="op">(</span><span class="va">studyPop</span><span class="op">)</span></span></code></pre></div>
<p>Run the propensity score model (setting cross-validation to FALSE
saves a lot of time, but this will still take a while):</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ps</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ohdsi.github.io/CohortMethod/reference/createPs.html" class="external-link">createPs</a></span><span class="op">(</span></span>
<span>  cohortMethodData <span class="op">=</span> <span class="va">cohortMethodData</span>,</span>
<span>  population <span class="op">=</span> <span class="va">studyPop</span>,</span>
<span>  maxCohortSizeForFitting <span class="op">=</span> <span class="fl">150000</span>,  <span class="co"># Caps the sample size for fitting</span></span>
<span>  prior <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/Cyclops/man/createPrior.html" class="external-link">createPrior</a></span><span class="op">(</span><span class="st">"laplace"</span>, useCrossValidation <span class="op">=</span> <span class="cn">FALSE</span>, exclude <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  control <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/Cyclops/man/createControl.html" class="external-link">createControl</a></span><span class="op">(</span></span>
<span>    noiseLevel <span class="op">=</span> <span class="st">"quiet"</span>,</span>
<span>    tolerance <span class="op">=</span> <span class="fl">1e-06</span>  <span class="co"># Slightly looser convergence criteria</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Because the propensity score model took so long to run, save and
reload it.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">saveRDS</a></span><span class="op">(</span><span class="va">ps</span>, <span class="st">"propensity_scores.rds"</span><span class="op">)</span></span>
<span><span class="va">ps</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">readRDS</a></span><span class="op">(</span><span class="st">"propensity_scores.rds"</span><span class="op">)</span></span></code></pre></div>
<p>Evaluate the propensity score model through the following 3 tests: 1.
Calculate AUC (area under the curve)</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ohdsi.github.io/CohortMethod/reference/computePsAuc.html" class="external-link">computePsAuc</a></span><span class="op">(</span><span class="va">ps</span><span class="op">)</span></span></code></pre></div>
<ol start="2" style="list-style-type: decimal">
<li>Plot propensity score distribution</li>
</ol>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ohdsi.github.io/CohortMethod/reference/plotPs.html" class="external-link">plotPs</a></span><span class="op">(</span><span class="va">ps</span>, </span>
<span>       scale <span class="op">=</span> <span class="st">"preference"</span>,</span>
<span>       showCountsLabel <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>       showAucLabel <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>       showEquiposeLabel <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span></code></pre></div>
<ol start="3" style="list-style-type: decimal">
<li>Check which variables are in the model</li>
</ol>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">psModel</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ohdsi.github.io/CohortMethod/reference/getPsModel.html" class="external-link">getPsModel</a></span><span class="op">(</span><span class="va">ps</span>, <span class="va">cohortMethodData</span><span class="op">)</span></span></code></pre></div>
<p>Next, you should adjust your study population for confounding (I use
the stratifyByPs methodbut you could also use matchOnPs or
trimByPsToEquipoise depending on your study needs). Then visualize the
adjusted study population.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">stratifiedPop</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ohdsi.github.io/CohortMethod/reference/stratifyByPs.html" class="external-link">stratifyByPs</a></span><span class="op">(</span><span class="va">ps</span>, numberOfStrata <span class="op">=</span> <span class="fl">5</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://ohdsi.github.io/CohortMethod/reference/plotPs.html" class="external-link">plotPs</a></span><span class="op">(</span><span class="va">stratifiedPop</span>, <span class="va">ps</span>, scale <span class="op">=</span> <span class="st">"preference"</span><span class="op">)</span></span></code></pre></div>
<p>The next four steps evaluate the balance of your covariates. 1.
Calculate the covariate balance</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">balance</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ohdsi.github.io/CohortMethod/reference/computeCovariateBalance.html" class="external-link">computeCovariateBalance</a></span><span class="op">(</span><span class="va">stratifiedPop</span>, <span class="va">cohortMethodData</span><span class="op">)</span></span></code></pre></div>
<ol start="2" style="list-style-type: decimal">
<li>Visualize the covariate balance using a scatter plot and a plot of
the most prevalent covariates.</li>
</ol>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ohdsi.github.io/CohortMethod/reference/plotCovariateBalanceScatterPlot.html" class="external-link">plotCovariateBalanceScatterPlot</a></span><span class="op">(</span><span class="va">balance</span>, showCovariateCountLabel <span class="op">=</span> <span class="cn">TRUE</span>, showMaxLabel <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ohdsi.github.io/CohortMethod/reference/plotCovariateBalanceOfTopVariables.html" class="external-link">plotCovariateBalanceOfTopVariables</a></span><span class="op">(</span><span class="va">balance</span><span class="op">)</span></span></code></pre></div>
<ol start="3" style="list-style-type: decimal">
<li>Create a table 1 of covariates comparing the study population before
and after adjustment.</li>
</ol>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ohdsi.github.io/CohortMethod/reference/createCmTable1.html" class="external-link">createCmTable1</a></span><span class="op">(</span><span class="va">balance</span><span class="op">)</span></span></code></pre></div>
<ol start="4" style="list-style-type: decimal">
<li>See how different the adjusted study population is from the original
study population by checking generalizability.</li>
</ol>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ohdsi.github.io/CohortMethod/reference/getGeneralizabilityTable.html" class="external-link">getGeneralizabilityTable</a></span><span class="op">(</span><span class="va">balance</span><span class="op">)</span></span></code></pre></div>
<p>The next two steps provide and assessment of the follow-up and the
statistical power of your model. 1. Calculate the minimum detectable
relative risk:</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ohdsi.github.io/CohortMethod/reference/computeMdrr.html" class="external-link">computeMdrr</a></span><span class="op">(</span></span>
<span>  population <span class="op">=</span> <span class="va">stratifiedPop</span>,</span>
<span>  modelType <span class="op">=</span> <span class="st">"cox"</span>,</span>
<span>  alpha <span class="op">=</span> <span class="fl">0.05</span>,</span>
<span>  power <span class="op">=</span> <span class="fl">0.8</span>,</span>
<span>  twoSided <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span></code></pre></div>
<ol start="2" style="list-style-type: decimal">
<li>Examine follow-up distribution:</li>
</ol>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ohdsi.github.io/CohortMethod/reference/getFollowUpDistribution.html" class="external-link">getFollowUpDistribution</a></span><span class="op">(</span>population <span class="op">=</span> <span class="va">stratifiedPop</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://ohdsi.github.io/CohortMethod/reference/plotFollowUpDistribution.html" class="external-link">plotFollowUpDistribution</a></span><span class="op">(</span>population <span class="op">=</span> <span class="va">stratifiedPop</span><span class="op">)</span></span></code></pre></div>
<p>Finally, you’re ready to run the outcome model to calculate the
difference of risk between the two populations (target_ID and
comparator_ID).</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#This is a simple outcome model (Cox regression with propensity adjustment).</span></span>
<span><span class="co">#There are also options for more complex models built into the CohortMethod</span></span>
<span><span class="co">#package.</span></span>
<span><span class="va">outcomeModel</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ohdsi.github.io/CohortMethod/reference/fitOutcomeModel.html" class="external-link">fitOutcomeModel</a></span><span class="op">(</span></span>
<span>  population <span class="op">=</span> <span class="va">stratifiedPop</span>,</span>
<span>  modelType <span class="op">=</span> <span class="st">"cox"</span>,</span>
<span>  stratified <span class="op">=</span> <span class="cn">TRUE</span>  <span class="co"># For stratified populations</span></span>
<span><span class="op">)</span></span>
<span><span class="va">outcomeModel</span>  <span class="co">#View results</span></span></code></pre></div>
<p>Now that you have your CohortMethod results, you can visualize them
in a variety of ways. 1. Create Kaplan-Meier plot:</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ohdsi.github.io/CohortMethod/reference/plotKaplanMeier.html" class="external-link">plotKaplanMeier</a></span><span class="op">(</span><span class="va">stratifiedPop</span>, includeZero <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<ol start="2" style="list-style-type: decimal">
<li>Create time-to-event plot:</li>
</ol>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ohdsi.github.io/CohortMethod/reference/plotTimeToEvent.html" class="external-link">plotTimeToEvent</a></span><span class="op">(</span></span>
<span>  cohortMethodData <span class="op">=</span> <span class="va">cohortMethodData</span>,</span>
<span>  outcomeId <span class="op">=</span> <span class="fl">4861</span>,</span>
<span>  firstExposureOnly <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  washoutPeriod <span class="op">=</span> <span class="fl">0</span>,</span>
<span>  removeDuplicateSubjects <span class="op">=</span> <span class="st">"keep all"</span>,</span>
<span>  minDaysAtRisk <span class="op">=</span> <span class="fl">1</span>,</span>
<span>  riskWindowStart <span class="op">=</span> <span class="fl">0</span>,</span>
<span>  startAnchor <span class="op">=</span> <span class="st">"cohort start"</span>,</span>
<span>  riskWindowEnd <span class="op">=</span> <span class="fl">30</span>,</span>
<span>  endAnchor <span class="op">=</span> <span class="st">"cohort end"</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>That’s it! Obviously, many of the packages settings can be adjusted
to fit your study needs. The above just provides an example of what a
CohortMethod analysis might look like when run against OHDSI Lab
data.</p>
  </main>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Louisa Smith, Rob Cavanaugh.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.2.</p>
</div>

    </footer>
</div>





  </body>
</html>
